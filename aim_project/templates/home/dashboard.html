{% extends 'base_dashboard.html' %} {% load static %} {% block dashboard_content %}
<div class="dashboard-main-content">
    <h1 class="dashboard-title">AIM DASHBOARD</h1>

    <div class="upload-section">
        <div class="upload-row">
            <div class="upload-item">
                <span class="upload-label">Add job description</span>
                <button class="btn btn-upload" id="jd-upload-btn" data-bs-toggle="modal" data-bs-target="#jobDescriptionModal">
                    Upload
                </button> {% if latest_jd %}
                <div class="upload-status success">
                    <i class="fas fa-check-circle"></i> {{ latest_jd.title }}
                </div>
                {% endif %}
            </div>

            <div class="upload-item">
                <span class="upload-label">Add CV</span>
                <button class="btn btn-upload" id="cv-upload-btn" data-bs-toggle="modal" data-bs-target="#resumeModal">
                    Upload
                </button> {% if latest_resume %}
                <div class="upload-status success">
                    <i class="fas fa-check-circle"></i> {{ latest_resume.title }}
                </div>
                {% endif %}
            </div>
        </div>

        <div class="start-interview-container">
            <a href="{% url 'interview_session' %}" class="btn btn-start-interview" {% if not can_start_interview %}disabled{% endif %}>
                Start Interview
            </a>
        </div>
    </div>

    <div class="dashboard-calendar">
        <div class="calendar-header">
            <h3>Upcoming Interviews</h3>
            <div class="calendar-navigation">
                <button class="btn btn-calendar-nav" id="prev-month"><i class="fas fa-chevron-left"></i></button>
                <span id="current-month">{{ current_month }}</span>
                <button class="btn btn-calendar-nav" id="next-month"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div class="calendar-container" id="calendar">
            <!-- Calendar will be rendered here by JavaScript -->
        </div>
    </div>
</div>

<!-- Job Description Upload Modal -->
<div class="modal fade" id="jobDescriptionModal" tabindex="-1" aria-labelledby="jobDescriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jobDescriptionModalLabel">Upload Job Description</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'upload_jd' %}" enctype="multipart/form-data" id="jd-upload-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_title" class="form-label">Job Title</label>
                        <input type="text" class="form-control" id="id_title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_file" class="form-label">Job Description File</label>
                        <input type="file" class="form-control" id="id_file" name="file" accept=".pdf,.doc,.docx,.txt" required>
                        <div class="form-text">Accepted formats: PDF, DOC, DOCX, TXT</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Resume Upload Modal -->
<div class="modal fade" id="resumeModal" tabindex="-1" aria-labelledby="resumeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resumeModalLabel">Upload CV/Resume</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'upload_resume' %}" enctype="multipart/form-data" id="resume-upload-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_title" class="form-label">Resume Title</label>
                        <input type="text" class="form-control" id="id_title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_file" class="form-label">Resume File</label>
                        <input type="file" class="form-control" id="id_file" name="file" accept=".pdf,.doc,.docx,.txt" required>
                        <div class="form-text">Accepted formats: PDF, DOC, DOCX, TXT</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Interview Scheduling Modal -->
<div class="modal fade" id="scheduleInterviewModal" tabindex="-1" aria-labelledby="scheduleInterviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleInterviewModalLabel">Schedule Interview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'schedule_interview' %}" id="schedule-interview-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_scheduled_date" class="form-label">Interview Date and Time</label>
                        <input type="datetime-local" class="form-control" id="id_scheduled_date" name="scheduled_date" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Schedule</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize calendar
        initCalendar();

        // Handle Start Interview button
        const startInterviewBtn = document.getElementById('start-interview-btn');
        if (startInterviewBtn) {
            startInterviewBtn.addEventListener('click', function(e) {
                if (this.hasAttribute('disabled')) {
                    e.preventDefault();
                }
            });
        }

        // Handle file uploads with AJAX
        const jdForm = document.getElementById('jd-upload-form');
        const resumeForm = document.getElementById('resume-upload-form');

        if (jdForm) {
            jdForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitFormWithAjax(this, 'jobDescriptionModal', updateJdStatus);
            });
        }

        if (resumeForm) {
            resumeForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitFormWithAjax(this, 'resumeModal', updateResumeStatus);
            });
        }

        function submitFormWithAjax(form, modalId, successCallback) {
            const formData = new FormData(form);

            fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Close modal
                        bootstrap.Modal.getInstance(document.getElementById(modalId)).hide();

                        // Call success callback
                        successCallback(data);

                        // Check if both files are uploaded
                        checkStartInterviewButton();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function updateJdStatus(data) {
            const jdUploadBtn = document.getElementById('jd-upload-btn');
            let statusDiv = jdUploadBtn.nextElementSibling;

            if (!statusDiv || !statusDiv.classList.contains('upload-status')) {
                statusDiv = document.createElement('div');
                statusDiv.className = 'upload-status success';
                jdUploadBtn.parentNode.appendChild(statusDiv);
            }

            statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${data.jd_title}`;
        }

        function updateResumeStatus(data) {
            const cvUploadBtn = document.getElementById('cv-upload-btn');
            let statusDiv = cvUploadBtn.nextElementSibling;

            if (!statusDiv || !statusDiv.classList.contains('upload-status')) {
                statusDiv = document.createElement('div');
                statusDiv.className = 'upload-status success';
                cvUploadBtn.parentNode.appendChild(statusDiv);
            }

            statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${data.resume_title}`;
        }

        function checkStartInterviewButton() {
            const jdStatus = document.querySelector('#jd-upload-btn + .upload-status');
            const cvStatus = document.querySelector('#cv-upload-btn + .upload-status');
            const startInterviewBtn = document.getElementById('start-interview-btn');

            if (jdStatus && cvStatus) {
                startInterviewBtn.removeAttribute('disabled');
            }
        }

        // Calendar functionality
        function initCalendar() {
            const today = new Date();
            let currentMonth = today.getMonth();
            let currentYear = today.getFullYear();

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const daysOfWeek = ["S", "M", "T", "W", "T", "F", "S"];

            // Display current month and year
            document.getElementById('current-month').textContent = `${monthNames[currentMonth]} ${currentYear}`;

            // Generate calendar
            generateCalendar(currentMonth, currentYear);

            // Previous month button
            document.getElementById('prev-month').addEventListener('click', function() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                document.getElementById('current-month').textContent = `${monthNames[currentMonth]} ${currentYear}`;
                generateCalendar(currentMonth, currentYear);
            });

            // Next month button
            document.getElementById('next-month').addEventListener('click', function() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                document.getElementById('current-month').textContent = `${monthNames[currentMonth]} ${currentYear}`;
                generateCalendar(currentMonth, currentYear);
            });
        }

        function generateCalendar(month, year) {
            const calendarContainer = document.getElementById('calendar');
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Clear previous calendar
            calendarContainer.innerHTML = '';

            // Create table structure
            const table = document.createElement('table');
            table.className = 'calendar-table';

            // Create header row with day names
            const headerRow = document.createElement('tr');
            const daysOfWeek = ["S", "M", "T", "W", "T", "F", "S"];

            daysOfWeek.forEach(day => {
                const th = document.createElement('th');
                th.textContent = day;
                headerRow.appendChild(th);
            });

            table.appendChild(headerRow);

            // Create calendar days
            let date = 1;
            let dayCount = 0;

            // Create weeks
            for (let i = 0; i < 6; i++) {
                // Break if we've already used all days in the month
                if (date > daysInMonth) break;

                const row = document.createElement('tr');

                // Create days in a week
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');

                    if (i === 0 && j < firstDay) {
                        // Empty cells before the first day of the month
                        cell.textContent = '';
                    } else if (date > daysInMonth) {
                        // Empty cells after the last day of the month
                        cell.textContent = '';
                    } else {
                        // Regular day cells
                        cell.textContent = date;

                        // Highlight today's date
                        const today = new Date();
                        if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                            cell.classList.add('today');
                        }

                        // Add event listener for scheduling
                        cell.addEventListener('click', function() {
                            const selectedDate = new Date(year, month, date);
                            openScheduleModal(selectedDate);
                        });

                        date++;
                    }

                    row.appendChild(cell);
                }

                table.appendChild(row);
            }

            calendarContainer.appendChild(table);
        }

        function openScheduleModal(date) {
            // Set the date in the scheduling modal
            const dateTimeInput = document.getElementById('id_scheduled_date');

            // Format the date for datetime-local input
            const formattedDate = formatDateForInput(date);
            dateTimeInput.value = formattedDate;

            // Open the modal
            const scheduleModal = new bootstrap.Modal(document.getElementById('scheduleInterviewModal'));
            scheduleModal.show();
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
    });
</script>
{% endblock %}